-- Create database
CREATE DATABASE IF NOT EXISTS student_db;
USE student_db;

-- Create students table
CREATE TABLE IF NOT EXISTS students (
    usn VARCHAR(20) PRIMARY KEY,
    sname VARCHAR(50) NOT NULL
);

-- Create subjects table
CREATE TABLE IF NOT EXISTS subjects (
    subject_code VARCHAR(10) PRIMARY KEY,
    subject_name VARCHAR(100) NOT NULL,
    department VARCHAR(50) NOT NULL
);

-- Create marks table
CREATE TABLE IF NOT EXISTS marks (
    mark_id INT AUTO_INCREMENT PRIMARY KEY,
    usn VARCHAR(20) NOT NULL,
    subject_code VARCHAR(10) NOT NULL,
    semester INT NOT NULL CHECK (semester BETWEEN 1 AND 8),
    marks_obtained INT NOT NULL CHECK (marks_obtained BETWEEN 0 AND 100),
    UNIQUE KEY unique_student_subject_sem (usn, subject_code, semester),
    FOREIGN KEY (usn) REFERENCES students(usn)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    FOREIGN KEY (subject_code) REFERENCES subjects(subject_code)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);

-- Dashboard counts 
SELECT 
    (SELECT COUNT(*) FROM students) AS StudentCount,
    (SELECT COUNT(*) FROM subjects) AS SubjectCount;


-- RESULT QUERY (MySQL TEST VERSION)


SET @usn = '1NT21CS001';
SET @semester = 3;

SELECT 
    st.sname,
    m.subject_code,
    s.subject_name,
    m.marks_obtained
FROM marks m
JOIN students st ON m.usn = st.usn
JOIN subjects s ON m.subject_code = s.subject_code
WHERE m.usn = @usn
  AND m.semester = @semester;


-- PASS / FAIL CALCULATION

SELECT
    st.usn,
    st.sname,
    m.semester,
    CASE
        WHEN MIN(m.marks_obtained) >= 40 THEN 'PASS'
        ELSE 'FAIL'
    END AS Result
FROM students st
JOIN marks m ON st.usn = m.usn
GROUP BY st.usn, m.semester;
